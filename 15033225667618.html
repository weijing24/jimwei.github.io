<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  制作nginx和php的rpm包 - 小菜鸡
  
  </title>
 <meta name="description" content="个人博客">
 <link href="atom.xml" rel="alternate" title="小菜鸡" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">小菜鸡</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; 小菜鸡</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>容器</label></li>

          
            <li><a title="制作nginx和php的rpm包" href="15033225667618.html">制作nginx和php的rpm包</a></li>
          

      
        <li class="divider"></li>
        <li><label>web服务器</label></li>

          
            <li><a title="图解正向代理、反向代理、透明代理" href="15033223691311.html">图解正向代理、反向代理、透明代理</a></li>
          
            <li><a title="详解apache的allow和deny" href="15033200332645.html">详解apache的allow和deny</a></li>
          

      
        <li class="divider"></li>
        <li><label>卓越班学习</label></li>

          
            <li><a title="ELF和a.out文件格式的比较" href="15038328822812.html">ELF和a.out文件格式的比较</a></li>
          
            <li><a title="linux多线程编程入门" href="15038316827096.html">linux多线程编程入门</a></li>
          
            <li><a title="linux进程编程入门" href="15038316680304.html">linux进程编程入门</a></li>
          
            <li><a title="shell系统管理" href="15038311430982.html">shell系统管理</a></li>
          
            <li><a title="shell编程入门" href="15038311023811.html">shell编程入门</a></li>
          
            <li><a title="shell网络管理" href="15038310714574.html">shell网络管理</a></li>
          
            <li><a title="wait和waitpid详解" href="15033229130846.html">wait和waitpid详解</a></li>
          
            <li><a title="信号" href="15033227238921.html">信号</a></li>
          
            <li><a title="僵尸进程和孤儿进程" href="15033226512813.html">僵尸进程和孤儿进程</a></li>
          
            <li><a title="共享内存" href="15033226237472.html">共享内存</a></li>
          
            <li><a title="基于TCP的字符串传输程序" href="15033223148818.html">基于TCP的字符串传输程序</a></li>
          
            <li><a title="文件搜索" href="15033220404521.html">文件搜索</a></li>
          
            <li><a title="文件比较" href="15033218983068.html">文件比较</a></li>
          
            <li><a title="文件编辑" href="15033218793219.html">文件编辑</a></li>
          
            <li><a title="文件设置" href="15033218534320.html">文件设置</a></li>
          
            <li><a title="系统文件操作开发" href="15033218072587.html">系统文件操作开发</a></li>
          
            <li><a title="系统环境变量" href="15033217888989.html">系统环境变量</a></li>
          
            <li><a title="静态库和共享库开发" href="%E9%9D%99%E6%80%81%E5%BA%93%E5%92%8C%E5%85%B1%E4%BA%AB%E5%BA%93%E5%BC%80%E5%8F%91.html">静态库和共享库开发</a></li>
          

      
        <li class="divider"></li>
        <li><label>坑</label></li>

          
            <li><a title="<center>数据库非正常关闭导致无法启动问题</center>" href="15033220957416.html"><center>数据库非正常关闭导致无法启动问题</center></a></li>
          
            <li><a title="解决virtualbox安装增强工具失败的问题" href="15033217564988.html">解决virtualbox安装增强工具失败的问题</a></li>
          
            <li><a title="记一次ftp服务器搭建走过的坑" href="15033217230950.html">记一次ftp服务器搭建走过的坑</a></li>
          
            <li><a title="记一次mysql主从一致校验走过的坑" href="15033215794872.html">记一次mysql主从一致校验走过的坑</a></li>
          

      
        <li class="divider"></li>
        <li><label>日常运维</label></li>

          
            <li><a title="dns服务器报错解决" href="15038329582108.html">dns服务器报错解决</a></li>
          
            <li><a title="docker随谈" href="15038329005848.html">docker随谈</a></li>
          
            <li><a title="i节点，容易被人遗忘的节点" href="15038322315997.html">i节点，容易被人遗忘的节点</a></li>
          
            <li><a title="libc.so.6被删后导致系统无法使用的原因及解决方法" href="15038321032705.html">libc.so.6被删后导致系统无法使用的原因及解决方法</a></li>
          
            <li><a title="linux下nginx模块开发入门" href="15038318990451.html">linux下nginx模块开发入门</a></li>
          
            <li><a title="Linux下配置rsync服务器" href="15038318551859.html">Linux下配置rsync服务器</a></li>
          
            <li><a title="mysql初始化" href="15038316518471.html">mysql初始化</a></li>
          
            <li><a title="nagios安装" href="15038316187109.html">nagios安装</a></li>
          
            <li><a title="nagios配置" href="15038315676757.html">nagios配置</a></li>
          
            <li><a title="nginx、mysql、php等各编译参数查询" href="15038315492978.html">nginx、mysql、php等各编译参数查询</a></li>
          
            <li><a title="nginx性能优化技巧" href="15038314081873.html">nginx性能优化技巧</a></li>
          
            <li><a title="php安装memcache扩展" href="15038313472966.html">php安装memcache扩展</a></li>
          
            <li><a title="puppet和ansible比较" href="15038313193415.html">puppet和ansible比较</a></li>
          
            <li><a title="puppet学习笔记(二)" href="15038312823109.html">puppet学习笔记(二)</a></li>
          
            <li><a title="puppet学习笔记（一）" href="15038311899167.html">puppet学习笔记（一）</a></li>
          
            <li><a title="ssh大坑" href="15038309933322.html">ssh大坑</a></li>
          
            <li><a title="svn同步大坑" href="15038308908725.html">svn同步大坑</a></li>
          
            <li><a title="svn服务器搭建与迁移" href="15038308118838.html">svn服务器搭建与迁移</a></li>
          
            <li><a title="ubuntu mysql5.7源码安装" href="15033230940135.html">ubuntu mysql5.7源码安装</a></li>
          
            <li><a title="ubuntu php5.6源码安装" href="15033230316456.html">ubuntu php5.6源码安装</a></li>
          
            <li><a title="ubuntu下nginx的安裝" href="15033229668634.html">ubuntu下nginx的安裝</a></li>
          
            <li><a title="ubuntu安装php常见错误集锦" href="15033229497885.html">ubuntu安装php常见错误集锦</a></li>
          
            <li><a title="vim常用命令" href="15033229297218.html">vim常用命令</a></li>
          
            <li><a title="使用RAID进行磁盘管理" href="15033227857622.html">使用RAID进行磁盘管理</a></li>
          
            <li><a title="使用virt-manager创建和管理虚拟机" href="15033227559982.html">使用virt-manager创建和管理虚拟机</a></li>
          
            <li><a title="关于mysqld_safe" href="15033226078265.html">关于mysqld_safe</a></li>
          
            <li><a title="安装linux各种桌面环境" href="15033222846104.html">安装linux各种桌面环境</a></li>
          
            <li><a title="常用软件编译参数以及软件地址" href="15033222695994.html">常用软件编译参数以及软件地址</a></li>
          
            <li><a title="打造属于自己的vim利器" href="15033222443468.html">打造属于自己的vim利器</a></li>
          
            <li><a title="搭建本地yum源服务器" href="15033221654695.html">搭建本地yum源服务器</a></li>
          

      
        <li class="divider"></li>
        <li><label>http</label></li>

          
            <li><a title="HTTP协议 (七) Cookie" href="15038327056467.html">HTTP协议 (七) Cookie</a></li>
          
            <li><a title="HTTP协议 (六) 状态码详解" href="15038326831174.html">HTTP协议 (六) 状态码详解</a></li>
          
            <li><a title="HTTP协议 (五) 代理" href="15038326274764.html">HTTP协议 (五) 代理</a></li>
          
            <li><a title="HTTP协议 (四) 缓存" href="15038325535184.html">HTTP协议 (四) 缓存</a></li>
          
            <li><a title="HTTP协议 (三) 压缩" href="15038324866170.html">HTTP协议 (三) 压缩</a></li>
          
            <li><a title="HTTP协议 (二) 基本认证" href="15038324138209.html">HTTP协议 (二) 基本认证</a></li>
          
            <li><a title="HTTP协议 (一) HTTP协议详解" href="15038322654511.html">HTTP协议 (一) HTTP协议详解</a></li>
          

      
        <li class="divider"></li>
        <li><label>监控</label></li>

          
            <li><a title="zabbix安装排错过程" href="15033228802565.html">zabbix安装排错过程</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>容器</span></li>
                        
                          <li><a title="制作nginx和php的rpm包" href="15033225667618.html">制作nginx和php的rpm包</a></li>
                        

                    
                      <li class="side-title"><span>web服务器</span></li>
                        
                          <li><a title="图解正向代理、反向代理、透明代理" href="15033223691311.html">图解正向代理、反向代理、透明代理</a></li>
                        
                          <li><a title="详解apache的allow和deny" href="15033200332645.html">详解apache的allow和deny</a></li>
                        

                    
                      <li class="side-title"><span>卓越班学习</span></li>
                        
                          <li><a title="ELF和a.out文件格式的比较" href="15038328822812.html">ELF和a.out文件格式的比较</a></li>
                        
                          <li><a title="linux多线程编程入门" href="15038316827096.html">linux多线程编程入门</a></li>
                        
                          <li><a title="linux进程编程入门" href="15038316680304.html">linux进程编程入门</a></li>
                        
                          <li><a title="shell系统管理" href="15038311430982.html">shell系统管理</a></li>
                        
                          <li><a title="shell编程入门" href="15038311023811.html">shell编程入门</a></li>
                        
                          <li><a title="shell网络管理" href="15038310714574.html">shell网络管理</a></li>
                        
                          <li><a title="wait和waitpid详解" href="15033229130846.html">wait和waitpid详解</a></li>
                        
                          <li><a title="信号" href="15033227238921.html">信号</a></li>
                        
                          <li><a title="僵尸进程和孤儿进程" href="15033226512813.html">僵尸进程和孤儿进程</a></li>
                        
                          <li><a title="共享内存" href="15033226237472.html">共享内存</a></li>
                        
                          <li><a title="基于TCP的字符串传输程序" href="15033223148818.html">基于TCP的字符串传输程序</a></li>
                        
                          <li><a title="文件搜索" href="15033220404521.html">文件搜索</a></li>
                        
                          <li><a title="文件比较" href="15033218983068.html">文件比较</a></li>
                        
                          <li><a title="文件编辑" href="15033218793219.html">文件编辑</a></li>
                        
                          <li><a title="文件设置" href="15033218534320.html">文件设置</a></li>
                        
                          <li><a title="系统文件操作开发" href="15033218072587.html">系统文件操作开发</a></li>
                        
                          <li><a title="系统环境变量" href="15033217888989.html">系统环境变量</a></li>
                        
                          <li><a title="静态库和共享库开发" href="%E9%9D%99%E6%80%81%E5%BA%93%E5%92%8C%E5%85%B1%E4%BA%AB%E5%BA%93%E5%BC%80%E5%8F%91.html">静态库和共享库开发</a></li>
                        

                    
                      <li class="side-title"><span>坑</span></li>
                        
                          <li><a title="<center>数据库非正常关闭导致无法启动问题</center>" href="15033220957416.html"><center>数据库非正常关闭导致无法启动问题</center></a></li>
                        
                          <li><a title="解决virtualbox安装增强工具失败的问题" href="15033217564988.html">解决virtualbox安装增强工具失败的问题</a></li>
                        
                          <li><a title="记一次ftp服务器搭建走过的坑" href="15033217230950.html">记一次ftp服务器搭建走过的坑</a></li>
                        
                          <li><a title="记一次mysql主从一致校验走过的坑" href="15033215794872.html">记一次mysql主从一致校验走过的坑</a></li>
                        

                    
                      <li class="side-title"><span>日常运维</span></li>
                        
                          <li><a title="dns服务器报错解决" href="15038329582108.html">dns服务器报错解决</a></li>
                        
                          <li><a title="docker随谈" href="15038329005848.html">docker随谈</a></li>
                        
                          <li><a title="i节点，容易被人遗忘的节点" href="15038322315997.html">i节点，容易被人遗忘的节点</a></li>
                        
                          <li><a title="libc.so.6被删后导致系统无法使用的原因及解决方法" href="15038321032705.html">libc.so.6被删后导致系统无法使用的原因及解决方法</a></li>
                        
                          <li><a title="linux下nginx模块开发入门" href="15038318990451.html">linux下nginx模块开发入门</a></li>
                        
                          <li><a title="Linux下配置rsync服务器" href="15038318551859.html">Linux下配置rsync服务器</a></li>
                        
                          <li><a title="mysql初始化" href="15038316518471.html">mysql初始化</a></li>
                        
                          <li><a title="nagios安装" href="15038316187109.html">nagios安装</a></li>
                        
                          <li><a title="nagios配置" href="15038315676757.html">nagios配置</a></li>
                        
                          <li><a title="nginx、mysql、php等各编译参数查询" href="15038315492978.html">nginx、mysql、php等各编译参数查询</a></li>
                        
                          <li><a title="nginx性能优化技巧" href="15038314081873.html">nginx性能优化技巧</a></li>
                        
                          <li><a title="php安装memcache扩展" href="15038313472966.html">php安装memcache扩展</a></li>
                        
                          <li><a title="puppet和ansible比较" href="15038313193415.html">puppet和ansible比较</a></li>
                        
                          <li><a title="puppet学习笔记(二)" href="15038312823109.html">puppet学习笔记(二)</a></li>
                        
                          <li><a title="puppet学习笔记（一）" href="15038311899167.html">puppet学习笔记（一）</a></li>
                        
                          <li><a title="ssh大坑" href="15038309933322.html">ssh大坑</a></li>
                        
                          <li><a title="svn同步大坑" href="15038308908725.html">svn同步大坑</a></li>
                        
                          <li><a title="svn服务器搭建与迁移" href="15038308118838.html">svn服务器搭建与迁移</a></li>
                        
                          <li><a title="ubuntu mysql5.7源码安装" href="15033230940135.html">ubuntu mysql5.7源码安装</a></li>
                        
                          <li><a title="ubuntu php5.6源码安装" href="15033230316456.html">ubuntu php5.6源码安装</a></li>
                        
                          <li><a title="ubuntu下nginx的安裝" href="15033229668634.html">ubuntu下nginx的安裝</a></li>
                        
                          <li><a title="ubuntu安装php常见错误集锦" href="15033229497885.html">ubuntu安装php常见错误集锦</a></li>
                        
                          <li><a title="vim常用命令" href="15033229297218.html">vim常用命令</a></li>
                        
                          <li><a title="使用RAID进行磁盘管理" href="15033227857622.html">使用RAID进行磁盘管理</a></li>
                        
                          <li><a title="使用virt-manager创建和管理虚拟机" href="15033227559982.html">使用virt-manager创建和管理虚拟机</a></li>
                        
                          <li><a title="关于mysqld_safe" href="15033226078265.html">关于mysqld_safe</a></li>
                        
                          <li><a title="安装linux各种桌面环境" href="15033222846104.html">安装linux各种桌面环境</a></li>
                        
                          <li><a title="常用软件编译参数以及软件地址" href="15033222695994.html">常用软件编译参数以及软件地址</a></li>
                        
                          <li><a title="打造属于自己的vim利器" href="15033222443468.html">打造属于自己的vim利器</a></li>
                        
                          <li><a title="搭建本地yum源服务器" href="15033221654695.html">搭建本地yum源服务器</a></li>
                        

                    
                      <li class="side-title"><span>http</span></li>
                        
                          <li><a title="HTTP协议 (七) Cookie" href="15038327056467.html">HTTP协议 (七) Cookie</a></li>
                        
                          <li><a title="HTTP协议 (六) 状态码详解" href="15038326831174.html">HTTP协议 (六) 状态码详解</a></li>
                        
                          <li><a title="HTTP协议 (五) 代理" href="15038326274764.html">HTTP协议 (五) 代理</a></li>
                        
                          <li><a title="HTTP协议 (四) 缓存" href="15038325535184.html">HTTP协议 (四) 缓存</a></li>
                        
                          <li><a title="HTTP协议 (三) 压缩" href="15038324866170.html">HTTP协议 (三) 压缩</a></li>
                        
                          <li><a title="HTTP协议 (二) 基本认证" href="15038324138209.html">HTTP协议 (二) 基本认证</a></li>
                        
                          <li><a title="HTTP协议 (一) HTTP协议详解" href="15038322654511.html">HTTP协议 (一) HTTP协议详解</a></li>
                        

                    
                      <li class="side-title"><span>监控</span></li>
                        
                          <li><a title="zabbix安装排错过程" href="15033228802565.html">zabbix安装排错过程</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>制作nginx和php的rpm包</h1>

<p>　　rpm包的制作真几把烦，制作php的rpm花了我3天时间，因为是根据线上环境来做的，依赖的第三方库太多，本来想把所有的第三方库做进php包，后来发现在rpmbuild -bb的时候非常耗时，而且乱七八糟的错满天飞，好不容易全部解决了第一次成功第二次又不行了，因此决定能用yum安装的就用yum安装，没有的才用源码。</p>

<h3 id="toc_0">1.安装rpm-build和rpmdevtools</h3>

<p>　　yum install rpmdevtools rpm-build</p>

<h3 id="toc_1">2.生成制作rpm包的必备目录，没有安装rpmdevtools则无法使用以下命令</h3>

<p>　　cd ~<br/>
　　rpmdev-setuptree<br/>
　　此时，你的家目录中有一个rpmbuild文件夹，里面有5个文件夹，分别是SPEC,SOURCE,RPMS,BUILD,SRPMS。spec文件夹存放书写生成rpm包的文件，rpms存放生成的rpm包，build存放生成rpm包过程中产生的文件，SRPMS存放srpm包，source存放源码文件和你要装入系统的文件</p>

<h3 id="toc_2">3.生成过程</h3>

<p>　　将nginx/php的源码包、配置文件，init.d中的启动文件放入source目录下，进入spec文件夹，写spec文件<br/>
　　nginx.spec</p>

<blockquote>
<pre><code>%define nginx_user nginx
#after compile no dependies check
AutoReqProv:    no
Name:           tengine
Version:        2.1.2
Release:        1%{?dist}
Summary:        Tengine from taobao
Group:          System Environment/Daemons
License:        GPLv2
URL:            http://www.nginx.org/downloads/nginx-1.2.1.tar.gz
Source0:        %{name}-%{version}.tar.gz
Source1:        tengine.init
#Source2:       pcre-8.32.tar.gz
BuildRoot:      %{_topdir}/BUILDROOT/%{name}-%{version}-%{release}
BuildRequires:  gcc,make
#Requires:      pcre,pcre-devel,openssl,openssl-devel,zlib,zlib-devel
#Requires(post):        info
#Requires(preun):info
%description
nginx from taobao

%prep
%setup -q
%build export DESTDIR=%{buildroot}
./configure\
    --prefix=/usr/local/sina_mobile/tengine\
    --sbin-path=/usr/local/sina_mobile/tengine/sbin/nginx\
    --conf-path=/usr/local/sina_mobile/tengine/conf/nginx.conf\
    --error-log-path=/usr/local/sina_mobile/tengine/logs/error.log\
    --http-log-path=/usr/local/sina_mobile/tengine/logs/access.log\
    --pid-path=/usr/local/sina_mobile/tengine/logs/nginx.pid\
    --http-client-body-temp-path=/usr/local/sina_mobile/tengine/client_body_temp \
    --http-proxy-temp-path=/usr/local/sina_mobile/tengine/proxy_temp \
    --http-fastcgi-temp-path=/usr/local/sina_mobile/tengine/fcgi_temp \
    --http-uwsgi-temp-path=/usr/local/sina_mobile/tengine/uwsgi_temp \
    --http-scgi-temp-path=/usr/local/sina_mobile/tengine/scgi_temp \
    --user=%{nginx_user}\
    --group=%{nginx_user}\
    --with-http_ssl_module \
    --with-http_stub_status_module \
    --with-http_gzip_static_module \
    --with-http_realip_module\
    --with-pcre=/usr/local/src/pcre-8.32\
    --with-openssl=/usr/local/src/openssl-1.0.1t\
    --with-zlib=/usr/local/src/zlib-1.2.8
    #  --with-pcre
    make %{?_smp_mflags}

%install
rm -rf %{buildroot}%{_infodir}/dir
make install DESTDIR=%{buildroot}
install -p -D -m 0755 %{SOURCE1} %{buildroot}/etc/rc.d/init.d/nginx
#install -p -D -m 0755 %{SOURCE2} %{buildroot}/usr/local/src/pcre-8.32.tar.gz
#install -p -d -m 0755 %{buildroot}/usr/local/nginx/sbin
#install -p -d -m 0755 %{buildroot}/usr/local/nginx/conf
#install -p -d -m 0755 %{buildroot}/usr/local/nginx/log

%pre
if [ $1 == 1 ];then
    /usr/sbin/useradd -s /bin/false -r %{nginx_user} 2&gt;/dev/null || :
fi

%post
if [ $1 == 1 ];then
    /sbin/chkconfig --add nginx
    /sbin/install-info %{_infodir}/%{name}.info %{_infodir}/dir 2&gt;/dev/null || :
fi

%preun
if [ $1 == 0 ];then
    /sbin/service nginx stop &gt; /dev/null 2&gt;&amp;1
    /sbin/chkconfig --del nginx
    /usr/sbin/userdel -r %{nginx_user} 2&gt; /dev/null
    /sbin/install-info --delete %{_infodir}/%{name}.info %{_infodir}/dir 2&gt;/dev/null || :
fi

%postun
rm -rf /usr/local/sina_mobile/tengine/sbin
rm -rf /usr/local/sina_mobile/tengine/conf
rm -rf /usr/local/sina_mobile/tengine/*_temp
rm -rf /usr/local/sina_mobile/tengine/include
rm -rf /usr/local/sina_mobile/tengine/html
rm -rf /usr/local/sina_mobile/tengine/modules
#rm -rf /usr/local/src/pcre-8.32
rm -f /etc/rc.d/init.d/nginx

%clean
rm -rf %{buildroot}

%files
%defattr(-,root,root,-)
#/usr/local/src/pcre-8.32
/usr/local/sina_mobile/tengine/*
%attr(0755,root,root) /etc/rc.d/init.d/nginx

%changelog
*  Fri Jul 5 2016 laoguang &lt;weijing@qq.com&gt; - 2.1.2-1.el6
- Initial version
</code></pre>
</blockquote>

<p>rpmbuild -bb nginx.spec即可生成rpm包</p>

<p>php.spec</p>

<blockquote>
<pre><code>%define     php_path    /usr/local/sina_mobile/php538
%define     dep_path    /usr/local/sina_mobile
%define     debug_package   %{nil}
AutoReq:    0
#AutoProv:  0

Name:       sinabook-php
Version:    5.3.8
Release:    1%{?dist}
Summary:    PHP is a server-side scripting language for creating dynamic Web page
Group:      System Environment/Daemons
License:    GPLv2
URL:        http://www.php.net/downloads/php-5.6.8.tar.gz 
Source0:    %{name}-%{version}.tar.gz
#Source1:   php-fpm
Source2:    php-fpm.conf
Source3:    php538.ini
BuildRoot:  %{_topdir}/BUILDROOT/%{name}-%{version}-%{release}
BuildRequires:  gcc,gcc-c++,make,cmake,ncurses-devel,bison,openssl-devel,libcurl-devel,gdbm-devel,openldap-devel,libtidy-devel,zlib-devel,libxml2-devel,pcre-devel,freetype-devel,libmcrypt-devel,libjpeg-devel,libpng-devel,libXpm-devel
#Requires:      sinabook-mysql,sinabook-libiconv
#Requires:   sinabook-gd &gt;= 2.1.0 
%description
PHP is a widely-used general-purpose scripting language that is especially suited for Web development and can be embedded into HTML.

%prep
%setup -q

%build
./configure\
    --prefix=%{php_path} \
    --with-config-file-path=%{php_path}/lib \
    --with-config-file-scan-dir=%{php_path}/lib/php.d \
    --with-curl \
    --with-mhash \
    --with-xmlrpc \
    --with-tidy \
    --with-ldap \
    --with-pear \
    --with-gdbm \
    --with-openssl \
    --with-gettext \
    --with-zlib \
    --with-mcrypt \
    --with-iconv=%{dep_path}/libiconv \
    --with-gd=%{dep_path}/gd\
    --with-jpeg-dir\
    --with-png-dir\
    --with-freetype-dir\
    --with-libXpm-dir=/usr/lib64\
    --with-mysql=%{dep_path}/mysql \
    --with-mysqli=%{dep_path}/mysql/bin/mysql_config \
    --with-pdo-mysql=/usr/local/sina_mobile/mysql \
    --enable-fpm --enable-mbstring --enable-zip --enable-soap --enable-sysvsem --enable-shmop --enable-sockets --enable-ftp --enable-gd-native-ttf --enable-bcmath --enable-pcntl --enable-maintainer-zts
make %{?_smp_mflags}

%install
rm -rf %{buildroot}
rm -rf %{buildroot}/{.channels,.depdb,.depdblock,.filemap,.lock,.registry}
make install INSTALL_ROOT=%{buildroot}
mkdir -p %{buildroot}%{_initrddir}
rm %{buildroot}/%{php_path}/bin/phar
ln -sf %{php_path}/bin/phar.phar %{buildroot}/%{php_path}/bin/phar
#install -p -D -m 0755  %{SOURCE1}   %{buildroot}%{_initrddir}/php-fpm
install -p -D -m 0644   %{SOURCE2}   %{buildroot}%{php_path}/etc/php-fpm.conf
install -p -D -m 0644   %{SOURCE3}   %{buildroot}%{php_path}/etc/php.ini

#Grep reports BUILDROOT inside our object files; disable that test.
QA_SKIP_BUILD_ROOT=1
QA_RPATHS=$[ 0x0001|0x0010 ]
export QA_SKIP_BUILD_ROOT
export QA_RPATHS

%clean
rm -rf %{buildroot}

%post
if [ $1 == 1 ];then
    /sbin/chkconfig --add php-fpm
    /sbin/chkconfig php-fpm on
fi

%preun
if [ $1 == 0 ] ; then
    /sbin/service php-fpm stop &gt; /dev/null 2&gt;&amp;1
    /sbin/chkconfig --del php-fpm
fi

#%postun
#if [ $1 == 0 ] ; then  
#   /bin/rm -rf %{php_path}
#fi

%files
%defattr(-,root,root,-)
%{php_path}
#%config(noreplace) %{php_path}/etc/php-fpm.conf
#%config(noreplace) %{php_path}/etc/php.ini
#%attr(0755,root,root) /etc/rc.d/init.d/php-fpm
%exclude /.channels
%exclude /.depdb
%exclude /.depdblock
%exclude /.filemap
%exclude /.lock

%changelog
*  Thu Jul 21 2016 weijing &lt;645509024@qq.com&gt; - 5.3.8-1.el6
- Initial version
</code></pre>
</blockquote>

<p>php-fpm里面关于php的路径需要修改为实际安装的路径，此文件在源码包的support-files中有<br/>
php-fpm.conf将pid，log等几个参数的注释去掉，然后就能启动了<br/>
使用此php包的前提是已经安装了mysql，并且系统能找到libmysqlclient.so.18<br/>
<img src="media/15033225667618/15033225959140.jpg" alt=""/><br/>
mysql.spec</p>

<blockquote>
<pre><code>%define mysql_user mysql
%define mysql_group mysql
%define debug_package   %{nil}
AutoReq:       0

Name:       sinabook-mysql
Version:    5.5.29
Release:    1%{?dist}
Summary:    database
Group:      System Environment/Daemons
License:    GPLv2
URL:        http://www.mysql.com/downloads/%{name}-%{version}.tar.gz
Source0:    %{name}-%{version}.tar.gz
Source1:    mysql3306.cnf
Source2:    mysql
BuildRoot:  %{_topdir}/%{name}-%{version}-%{release}-XXXXXX)
BuildRequires:  gcc-c++,ncurses,ncurses-devel,bison,cmake,zlib

%description
%prep
%setup -q

%build
cmake -DCMAKE_INSTALL_PREFIX=/usr/local/sina_mobile/mysql -DWITH_MYISAM_STORAGE_ENGINE=1 -DWITH_INNOBASE_STORAGE_ENGINE=1 -DWITH_ARCHIVE_STORAGE_ENGINE=1 -DWITH_BLACKHOLE_STORAGE_ENGINE=1 -DWITH_MEMORY_STORAGE_ENGINE=1 -DWITH_PARTITION_STORAGE_ENGINE=1 -DWITH_PERFSCHEMA_STORAGE_ENGINE=1 -DWITH_PIC=0 -DWITH_READLINE=1  -DWITH_DEBUG=0  -DENABLED_LOCAL_INFILE=1 -DEXTRA_CHARSETS=all -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -Wno-dev
make %{?_smp_mflags}

%install
rm -rf %{buildroot}
make install DESTDIR=%{buildroot}
install -p -D -m 0755 %{SOURCE1} %{buildroot}/data/mysql3306/mysql3306.cnf
install -p -D -m 0755 %{SOURCE2} %{buildroot}/etc/init.d/mysql

%pre 
if [ $1 == 1 ];then
    /usr/sbin/groupadd mysql
    /usr/sbin/useradd -r %{mysql_user} -M -g %{mysql_group} -s /bin/false 2&gt;/dev/null || :
fi

%post
if [ $1 == 1 ];then
    /bin/chown -R mysql:mysql /usr/local/sina_mobile/mysql
    /usr/local/sina_mobile/mysql/scripts/mysql_install_db --user=mysql --basedir=/usr/local/sina_mobile/mysql --datadir=/data/mysql3306
    /bin/chown -R root /usr/local/sina_mobile/mysql
    /bin/chown -R mysql /data/mysql3306
    #/bin/cp /usr/local/sina_mobile/mysql/support-files/mysql.server /etc/init.d/mysql
    #/bin/sed -i &quot;s@^basedir=@basedir=/usr/local/sina_mobile/mysql@g;s@^datadir=@datadir=/data/mysql3306@g;s@conf=/etc/my.cnf@conf=/data/mysql3306/mysql3306.cnf@g&quot; /etc/init.d/mysql
    #/bin/chmod 755 /etc/init.d/mysql
    /sbin/chkconfig --add mysql
    #/bin/echo &quot;PATH=$PATH:/usr/local/sina_mobile/mysql/bin&quot; &gt;/etc/profile.d/mysql.sh
    #source /etc/profile.d/mysql.sh
    #/bin/echo &quot;/usr/local/sina_mobile/mysql/lib&quot; &gt; /etc/ld.so.conf.d/mysql.conf
    #/sbin/ldconfig &gt; /dev/null 2&gt;&amp;1
    /bin/ln -s /data/mysql3306/mysql3306.sock /tmp/mysql.sock 2&gt;/dev/null
    /bin/ln -s /usr/local/sina_mobile/mysql/bin/* /usr/local/bin/
    /bin/ln -s /usr/local/sina_mobile/mysql/scripts/* /usr/local/bin/
    /sbin/install-info %{_infodir}/%{name}.info %{_infodir}/dir 2&gt;/dev/null || :
fi

%preun
if [ $1 == 0 ];then
    /sbin/service mysql stop &gt; /dev/null 2&gt;&amp;1
    /sbin/chkconfig --del mysql
    #/usr/sbin/userdel -r %{mysql_user} 2&gt; /dev/null
    #/usr/sbin/groupdel %{mysql_user} 2&gt; /dev/null
    /sbin/install-info --delete %{_infodir}/%{name}.info %{_infodir}/dir 2&gt;/dev/null || :
fi

%postun
#rm -rf /etc/profile.d/mysql.sh
#rm -rf /etc/ld.so.conf.d/mysql.conf
rm -rf /tmp/mysql.sock
rm -rf /usr/local/bin/mysql*
rm -rf /usr/local/bin/myisam*
rm -rf /usr/local/bin/resolve*
rm -rf /usr/local/bin/{innochecksum,msql2mysql,my_print_defaults,perror,replace}
rm -rf /usr/local/sina_mobile/mysql/*
rm -rf /etc/init.d/mysql

%clean
rm -rf %{buildroot}

%files
%defattr(-,root,root,-)
/usr/local/sina_mobile/mysql/*
/data/mysql3306/mysql3306.cnf
%attr(0755,root,root) /etc/init.d/mysql
%doc

%changelog
*  Thu Jul 21 2016 weijing &lt;645509024@qq.com&gt; - 5.5.29-1.el6
- Initial version
</code></pre>
</blockquote>

<p>全部搞定，搞了爸爸一周，不过感觉对于包管理和rpm打包的流程清晰了很多，可能以后安装别的包发生了dependence错误会更清楚的知道哪里出了问题</p>

<p>附上友情链接：</p>

<p>[制作php的rpm包]<a href="http://blog.digitalstruct.com/2011/12/21/rpm-packaging-building-and-deploying-your-own-php/">http://blog.digitalstruct.com/2011/12/21/rpm-packaging-building-and-deploying-your-own-php/</a>　　　　</p>

<p>[制作nginx的rpm包]<a href="http://www.centoscn.com/image-text/config/2014/1201/4215.html">http://www.centoscn.com/image-text/config/2014/1201/4215.html</a></p>

<p>[rpm包出错的解决方法]<a href="http://www.bkjia.com/Linuxjc/1088197.html">http://www.bkjia.com/Linuxjc/1088197.html</a></p>

<p>[rpm包每个字段的解释]<a href="http://ju.outofmemory.cn/entry/95476">http://ju.outofmemory.cn/entry/95476</a></p>

<p>[fedora的官方文档]<a href="http://fedoraproject.org/wiki/How_to_create_an_RPM_package">http://fedoraproject.org/wiki/How_to_create_an_RPM_package</a></p>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15033226078265.html"  title="Previous Post: 关于mysqld_safe">&laquo; 关于mysqld_safe</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15033223691311.html" 
	        title="Next Post: 图解正向代理、反向代理、透明代理">图解正向代理、反向代理、透明代理 &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15033225667618.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  </body>
</html>
