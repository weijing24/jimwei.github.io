<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  共享内存 - 小菜鸡
  
  </title>
 <meta name="description" content="个人博客">
 <link href="atom.xml" rel="alternate" title="小菜鸡" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">小菜鸡</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; 小菜鸡</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>容器</label></li>

          
            <li><a title="制作nginx和php的rpm包" href="15033225667618.html">制作nginx和php的rpm包</a></li>
          

      
        <li class="divider"></li>
        <li><label>web服务器</label></li>

          
            <li><a title="图解正向代理、反向代理、透明代理" href="15033223691311.html">图解正向代理、反向代理、透明代理</a></li>
          
            <li><a title="详解apache的allow和deny" href="15033200332645.html">详解apache的allow和deny</a></li>
          

      
        <li class="divider"></li>
        <li><label>卓越班学习</label></li>

          
            <li><a title="ELF和a.out文件格式的比较" href="15038328822812.html">ELF和a.out文件格式的比较</a></li>
          
            <li><a title="linux多线程编程入门" href="15038316827096.html">linux多线程编程入门</a></li>
          
            <li><a title="linux进程编程入门" href="15038316680304.html">linux进程编程入门</a></li>
          
            <li><a title="shell系统管理" href="15038311430982.html">shell系统管理</a></li>
          
            <li><a title="shell编程入门" href="15038311023811.html">shell编程入门</a></li>
          
            <li><a title="shell网络管理" href="15038310714574.html">shell网络管理</a></li>
          
            <li><a title="wait和waitpid详解" href="15033229130846.html">wait和waitpid详解</a></li>
          
            <li><a title="信号" href="15033227238921.html">信号</a></li>
          
            <li><a title="僵尸进程和孤儿进程" href="15033226512813.html">僵尸进程和孤儿进程</a></li>
          
            <li><a title="共享内存" href="15033226237472.html">共享内存</a></li>
          
            <li><a title="基于TCP的字符串传输程序" href="15033223148818.html">基于TCP的字符串传输程序</a></li>
          
            <li><a title="文件搜索" href="15033220404521.html">文件搜索</a></li>
          
            <li><a title="文件比较" href="15033218983068.html">文件比较</a></li>
          
            <li><a title="文件编辑" href="15033218793219.html">文件编辑</a></li>
          
            <li><a title="文件设置" href="15033218534320.html">文件设置</a></li>
          
            <li><a title="系统文件操作开发" href="15033218072587.html">系统文件操作开发</a></li>
          
            <li><a title="系统环境变量" href="15033217888989.html">系统环境变量</a></li>
          
            <li><a title="静态库和共享库开发" href="%E9%9D%99%E6%80%81%E5%BA%93%E5%92%8C%E5%85%B1%E4%BA%AB%E5%BA%93%E5%BC%80%E5%8F%91.html">静态库和共享库开发</a></li>
          

      
        <li class="divider"></li>
        <li><label>坑</label></li>

          
            <li><a title="<center>数据库非正常关闭导致无法启动问题</center>" href="15033220957416.html"><center>数据库非正常关闭导致无法启动问题</center></a></li>
          
            <li><a title="解决virtualbox安装增强工具失败的问题" href="15033217564988.html">解决virtualbox安装增强工具失败的问题</a></li>
          
            <li><a title="记一次ftp服务器搭建走过的坑" href="15033217230950.html">记一次ftp服务器搭建走过的坑</a></li>
          
            <li><a title="记一次mysql主从一致校验走过的坑" href="15033215794872.html">记一次mysql主从一致校验走过的坑</a></li>
          

      
        <li class="divider"></li>
        <li><label>日常运维</label></li>

          
            <li><a title="dns服务器报错解决" href="15038329582108.html">dns服务器报错解决</a></li>
          
            <li><a title="docker随谈" href="15038329005848.html">docker随谈</a></li>
          
            <li><a title="i节点，容易被人遗忘的节点" href="15038322315997.html">i节点，容易被人遗忘的节点</a></li>
          
            <li><a title="libc.so.6被删后导致系统无法使用的原因及解决方法" href="15038321032705.html">libc.so.6被删后导致系统无法使用的原因及解决方法</a></li>
          
            <li><a title="linux下nginx模块开发入门" href="15038318990451.html">linux下nginx模块开发入门</a></li>
          
            <li><a title="Linux下配置rsync服务器" href="15038318551859.html">Linux下配置rsync服务器</a></li>
          
            <li><a title="mysql初始化" href="15038316518471.html">mysql初始化</a></li>
          
            <li><a title="nagios安装" href="15038316187109.html">nagios安装</a></li>
          
            <li><a title="nagios配置" href="15038315676757.html">nagios配置</a></li>
          
            <li><a title="nginx、mysql、php等各编译参数查询" href="15038315492978.html">nginx、mysql、php等各编译参数查询</a></li>
          
            <li><a title="nginx性能优化技巧" href="15038314081873.html">nginx性能优化技巧</a></li>
          
            <li><a title="php安装memcache扩展" href="15038313472966.html">php安装memcache扩展</a></li>
          
            <li><a title="puppet和ansible比较" href="15038313193415.html">puppet和ansible比较</a></li>
          
            <li><a title="puppet学习笔记(二)" href="15038312823109.html">puppet学习笔记(二)</a></li>
          
            <li><a title="puppet学习笔记（一）" href="15038311899167.html">puppet学习笔记（一）</a></li>
          
            <li><a title="ssh大坑" href="15038309933322.html">ssh大坑</a></li>
          
            <li><a title="svn同步大坑" href="15038308908725.html">svn同步大坑</a></li>
          
            <li><a title="svn服务器搭建与迁移" href="15038308118838.html">svn服务器搭建与迁移</a></li>
          
            <li><a title="ubuntu mysql5.7源码安装" href="15033230940135.html">ubuntu mysql5.7源码安装</a></li>
          
            <li><a title="ubuntu php5.6源码安装" href="15033230316456.html">ubuntu php5.6源码安装</a></li>
          
            <li><a title="ubuntu下nginx的安裝" href="15033229668634.html">ubuntu下nginx的安裝</a></li>
          
            <li><a title="ubuntu安装php常见错误集锦" href="15033229497885.html">ubuntu安装php常见错误集锦</a></li>
          
            <li><a title="vim常用命令" href="15033229297218.html">vim常用命令</a></li>
          
            <li><a title="使用RAID进行磁盘管理" href="15033227857622.html">使用RAID进行磁盘管理</a></li>
          
            <li><a title="使用virt-manager创建和管理虚拟机" href="15033227559982.html">使用virt-manager创建和管理虚拟机</a></li>
          
            <li><a title="关于mysqld_safe" href="15033226078265.html">关于mysqld_safe</a></li>
          
            <li><a title="安装linux各种桌面环境" href="15033222846104.html">安装linux各种桌面环境</a></li>
          
            <li><a title="常用软件编译参数以及软件地址" href="15033222695994.html">常用软件编译参数以及软件地址</a></li>
          
            <li><a title="打造属于自己的vim利器" href="15033222443468.html">打造属于自己的vim利器</a></li>
          
            <li><a title="搭建本地yum源服务器" href="15033221654695.html">搭建本地yum源服务器</a></li>
          

      
        <li class="divider"></li>
        <li><label>http</label></li>

          
            <li><a title="HTTP协议 (七) Cookie" href="15038327056467.html">HTTP协议 (七) Cookie</a></li>
          
            <li><a title="HTTP协议 (六) 状态码详解" href="15038326831174.html">HTTP协议 (六) 状态码详解</a></li>
          
            <li><a title="HTTP协议 (五) 代理" href="15038326274764.html">HTTP协议 (五) 代理</a></li>
          
            <li><a title="HTTP协议 (四) 缓存" href="15038325535184.html">HTTP协议 (四) 缓存</a></li>
          
            <li><a title="HTTP协议 (三) 压缩" href="15038324866170.html">HTTP协议 (三) 压缩</a></li>
          
            <li><a title="HTTP协议 (二) 基本认证" href="15038324138209.html">HTTP协议 (二) 基本认证</a></li>
          
            <li><a title="HTTP协议 (一) HTTP协议详解" href="15038322654511.html">HTTP协议 (一) HTTP协议详解</a></li>
          

      
        <li class="divider"></li>
        <li><label>监控</label></li>

          
            <li><a title="zabbix安装排错过程" href="15033228802565.html">zabbix安装排错过程</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>容器</span></li>
                        
                          <li><a title="制作nginx和php的rpm包" href="15033225667618.html">制作nginx和php的rpm包</a></li>
                        

                    
                      <li class="side-title"><span>web服务器</span></li>
                        
                          <li><a title="图解正向代理、反向代理、透明代理" href="15033223691311.html">图解正向代理、反向代理、透明代理</a></li>
                        
                          <li><a title="详解apache的allow和deny" href="15033200332645.html">详解apache的allow和deny</a></li>
                        

                    
                      <li class="side-title"><span>卓越班学习</span></li>
                        
                          <li><a title="ELF和a.out文件格式的比较" href="15038328822812.html">ELF和a.out文件格式的比较</a></li>
                        
                          <li><a title="linux多线程编程入门" href="15038316827096.html">linux多线程编程入门</a></li>
                        
                          <li><a title="linux进程编程入门" href="15038316680304.html">linux进程编程入门</a></li>
                        
                          <li><a title="shell系统管理" href="15038311430982.html">shell系统管理</a></li>
                        
                          <li><a title="shell编程入门" href="15038311023811.html">shell编程入门</a></li>
                        
                          <li><a title="shell网络管理" href="15038310714574.html">shell网络管理</a></li>
                        
                          <li><a title="wait和waitpid详解" href="15033229130846.html">wait和waitpid详解</a></li>
                        
                          <li><a title="信号" href="15033227238921.html">信号</a></li>
                        
                          <li><a title="僵尸进程和孤儿进程" href="15033226512813.html">僵尸进程和孤儿进程</a></li>
                        
                          <li><a title="共享内存" href="15033226237472.html">共享内存</a></li>
                        
                          <li><a title="基于TCP的字符串传输程序" href="15033223148818.html">基于TCP的字符串传输程序</a></li>
                        
                          <li><a title="文件搜索" href="15033220404521.html">文件搜索</a></li>
                        
                          <li><a title="文件比较" href="15033218983068.html">文件比较</a></li>
                        
                          <li><a title="文件编辑" href="15033218793219.html">文件编辑</a></li>
                        
                          <li><a title="文件设置" href="15033218534320.html">文件设置</a></li>
                        
                          <li><a title="系统文件操作开发" href="15033218072587.html">系统文件操作开发</a></li>
                        
                          <li><a title="系统环境变量" href="15033217888989.html">系统环境变量</a></li>
                        
                          <li><a title="静态库和共享库开发" href="%E9%9D%99%E6%80%81%E5%BA%93%E5%92%8C%E5%85%B1%E4%BA%AB%E5%BA%93%E5%BC%80%E5%8F%91.html">静态库和共享库开发</a></li>
                        

                    
                      <li class="side-title"><span>坑</span></li>
                        
                          <li><a title="<center>数据库非正常关闭导致无法启动问题</center>" href="15033220957416.html"><center>数据库非正常关闭导致无法启动问题</center></a></li>
                        
                          <li><a title="解决virtualbox安装增强工具失败的问题" href="15033217564988.html">解决virtualbox安装增强工具失败的问题</a></li>
                        
                          <li><a title="记一次ftp服务器搭建走过的坑" href="15033217230950.html">记一次ftp服务器搭建走过的坑</a></li>
                        
                          <li><a title="记一次mysql主从一致校验走过的坑" href="15033215794872.html">记一次mysql主从一致校验走过的坑</a></li>
                        

                    
                      <li class="side-title"><span>日常运维</span></li>
                        
                          <li><a title="dns服务器报错解决" href="15038329582108.html">dns服务器报错解决</a></li>
                        
                          <li><a title="docker随谈" href="15038329005848.html">docker随谈</a></li>
                        
                          <li><a title="i节点，容易被人遗忘的节点" href="15038322315997.html">i节点，容易被人遗忘的节点</a></li>
                        
                          <li><a title="libc.so.6被删后导致系统无法使用的原因及解决方法" href="15038321032705.html">libc.so.6被删后导致系统无法使用的原因及解决方法</a></li>
                        
                          <li><a title="linux下nginx模块开发入门" href="15038318990451.html">linux下nginx模块开发入门</a></li>
                        
                          <li><a title="Linux下配置rsync服务器" href="15038318551859.html">Linux下配置rsync服务器</a></li>
                        
                          <li><a title="mysql初始化" href="15038316518471.html">mysql初始化</a></li>
                        
                          <li><a title="nagios安装" href="15038316187109.html">nagios安装</a></li>
                        
                          <li><a title="nagios配置" href="15038315676757.html">nagios配置</a></li>
                        
                          <li><a title="nginx、mysql、php等各编译参数查询" href="15038315492978.html">nginx、mysql、php等各编译参数查询</a></li>
                        
                          <li><a title="nginx性能优化技巧" href="15038314081873.html">nginx性能优化技巧</a></li>
                        
                          <li><a title="php安装memcache扩展" href="15038313472966.html">php安装memcache扩展</a></li>
                        
                          <li><a title="puppet和ansible比较" href="15038313193415.html">puppet和ansible比较</a></li>
                        
                          <li><a title="puppet学习笔记(二)" href="15038312823109.html">puppet学习笔记(二)</a></li>
                        
                          <li><a title="puppet学习笔记（一）" href="15038311899167.html">puppet学习笔记（一）</a></li>
                        
                          <li><a title="ssh大坑" href="15038309933322.html">ssh大坑</a></li>
                        
                          <li><a title="svn同步大坑" href="15038308908725.html">svn同步大坑</a></li>
                        
                          <li><a title="svn服务器搭建与迁移" href="15038308118838.html">svn服务器搭建与迁移</a></li>
                        
                          <li><a title="ubuntu mysql5.7源码安装" href="15033230940135.html">ubuntu mysql5.7源码安装</a></li>
                        
                          <li><a title="ubuntu php5.6源码安装" href="15033230316456.html">ubuntu php5.6源码安装</a></li>
                        
                          <li><a title="ubuntu下nginx的安裝" href="15033229668634.html">ubuntu下nginx的安裝</a></li>
                        
                          <li><a title="ubuntu安装php常见错误集锦" href="15033229497885.html">ubuntu安装php常见错误集锦</a></li>
                        
                          <li><a title="vim常用命令" href="15033229297218.html">vim常用命令</a></li>
                        
                          <li><a title="使用RAID进行磁盘管理" href="15033227857622.html">使用RAID进行磁盘管理</a></li>
                        
                          <li><a title="使用virt-manager创建和管理虚拟机" href="15033227559982.html">使用virt-manager创建和管理虚拟机</a></li>
                        
                          <li><a title="关于mysqld_safe" href="15033226078265.html">关于mysqld_safe</a></li>
                        
                          <li><a title="安装linux各种桌面环境" href="15033222846104.html">安装linux各种桌面环境</a></li>
                        
                          <li><a title="常用软件编译参数以及软件地址" href="15033222695994.html">常用软件编译参数以及软件地址</a></li>
                        
                          <li><a title="打造属于自己的vim利器" href="15033222443468.html">打造属于自己的vim利器</a></li>
                        
                          <li><a title="搭建本地yum源服务器" href="15033221654695.html">搭建本地yum源服务器</a></li>
                        

                    
                      <li class="side-title"><span>http</span></li>
                        
                          <li><a title="HTTP协议 (七) Cookie" href="15038327056467.html">HTTP协议 (七) Cookie</a></li>
                        
                          <li><a title="HTTP协议 (六) 状态码详解" href="15038326831174.html">HTTP协议 (六) 状态码详解</a></li>
                        
                          <li><a title="HTTP协议 (五) 代理" href="15038326274764.html">HTTP协议 (五) 代理</a></li>
                        
                          <li><a title="HTTP协议 (四) 缓存" href="15038325535184.html">HTTP协议 (四) 缓存</a></li>
                        
                          <li><a title="HTTP协议 (三) 压缩" href="15038324866170.html">HTTP协议 (三) 压缩</a></li>
                        
                          <li><a title="HTTP协议 (二) 基本认证" href="15038324138209.html">HTTP协议 (二) 基本认证</a></li>
                        
                          <li><a title="HTTP协议 (一) HTTP协议详解" href="15038322654511.html">HTTP协议 (一) HTTP协议详解</a></li>
                        

                    
                      <li class="side-title"><span>监控</span></li>
                        
                          <li><a title="zabbix安装排错过程" href="15033228802565.html">zabbix安装排错过程</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>共享内存</h1>

<p>使用共享内存步骤:<br/>
① 开辟一块共享内存shmget<br/>
② 允许本进程使用共某块共享内存shmat<br/>
③ 写入/读取</p>

<p>删除共享内存步骤<br/>
①禁止本进程使用这块共享内存shmdt<br/>
②删除这块共享内存shmctl或者命令行下ipcrm</p>

<h4 id="toc_0">1.创建共享内存</h4>

<p>任务描述：</p>

<ul>
<li>使用shmget函数创建共享内存，并输出创建的shmid</li>
<li>判断创建的shmid是否成功，失败返回-1，成功打印共享内存的id号</li>
</ul>

<p>相关知识：<br/>
　　共享内存函数由 shmget、shmat、shmdt、shmctl 四个函数组成。<br/>
　　①shmget函数<br/>
　　作用：得到一个共享内存标识符或创建一个共享内存对象<br/>
　　原型：int shmget(key_t key, size_t size, int shmflg)<br/>
　　②shamat函数<br/>
　　作用：连接共享内存标识符为 shmid 的共享内存,连接成功后把共享内存区对象映射到调用进程的地址空间,随后可像本地空间一样访问<br/>
　　原型：void *shmat(int shmid, const void *shmaddr, int shmflg)<br/>
　　③shmdt函数<br/>
　　作用：断开与共享内存附加点的地址,禁止本进程访问此片共享内存<br/>
　　原型：int shmdt(const void *shmaddr)<br/>
　　④shmctl函数<br/>
　　作用:完成对共享内存的控制<br/>
　　原型：int shmctl(int shmid, int cmd, struct shmid_ds *buf)</p>

<p>main.c:</p>

<blockquote>
<pre><code>#include &quot;stdio.h&quot;
#include &quot;unistd.h&quot;
#include &quot;sys/ipc.h&quot;
#include &quot;sys/shm.h&quot;
#include &quot;error.h&quot;
#define SIZE 1024
int main(void){
    int shmid ;
    shmid=shmget(IPC_PRIVATE,512,IPC_CREAT|0600 ) ;
    if ( shmid &lt; 0 ){
        perror(&quot;get shm ipc_id error&quot;) ;
        return -1 ;
    }
    printf(&quot;shmid=%d\n&quot;,shmid) ;
    return 0 ;
}
</code></pre>
</blockquote>

<h4 id="toc_1">2.使用fork函数创建子进程</h4>

<p>任务描述:</p>

<ul>
<li>在task1基础上使用fork创建子进程</li>
<li>在子进程中打印&quot;this is child&quot;,在父进程中打印&quot;this is parent&quot;</li>
</ul>

<p>main.c:</p>

<blockquote>
<pre><code>#include &quot;stdio.h&quot;
#include &quot;unistd.h&quot;
#include &quot;sys/ipc.h&quot;
#include &quot;sys/shm.h&quot;
#include &quot;error.h&quot;
int main(void){
    int shmid;
    struct shmid_ds buf;
    shmid=shmget(IPC_PRIVATE,512,IPC_CREAT|0600 ) ;
    if ( shmid &lt; 0 ){
        perror(&quot;get shm ipc_id error&quot;) ;
        return -1 ;
    }
    printf(&quot;shmid is %d\n&quot;,shmid);
    pid_t pid;
    pid=fork();
    if(pid&lt;0){
        perror(&quot;fork error\n&quot;);
        shmctl(shmid,IPC_RMID,&amp;buf);
    }
    if(pid==0)
        printf(&quot;this is child\n&quot;);
    else
        printf(&quot;this is parent\n&quot;);
    return 0 ;
}
</code></pre>
</blockquote>

<h4 id="toc_2">3.在子进程中将键盘输入字符串写入共享内存</h4>

<p>任务描述:</p>

<ul>
<li>在task2的基础上在子进程中使用shmat函数与共享内存空间建立联系</li>
<li>将共享内存映射到子进程中,将参数字符串拷贝到共享内存中.</li>
<li>拷贝完毕后使用shmdt函数分离共享内存对象</li>
</ul>

<p>main.c:</p>

<blockquote>
<pre><code>#include &quot;stdio.h&quot;
#include &quot;unistd.h&quot;
#include &quot;sys/ipc.h&quot;
#include &quot;sys/shm.h&quot;
#include &quot;error.h&quot;
#include &quot;stdlib.h&quot;
#include &quot;string.h&quot;
int main(void){
    int shmid;char x[10];
    struct shmid_ds buf;
    char *shmaddr;
    shmid=shmget(IPC_PRIVATE,512,IPC_CREAT|0600 ) ;
    if ( shmid &lt; 0 ){
        perror(&quot;get shm ipc_id error\n&quot;) ;
        return -1 ;
    }
    printf(&quot;shmid is %d\n&quot;,shmid);
    pid_t pid;
    pid=fork();
    if(pid&lt;0){
        perror(&quot;fork error\n&quot;);
        shmctl(shmid,IPC_RMID,&amp;buf); 
    }
    if(pid==0){
        printf(&quot;this is child\n&quot;);
        shmaddr=(char *)shmat(shmid,NULL,0);
        if(shmaddr&lt;(char *)0){
            perror(&quot;shmat addr error\n&quot;);
            return -1;
        }
        printf(&quot;write something to shm\n&quot;);
        fgets(x,11,stdin);
        strcpy(shmaddr,x);
        // printf(&quot;%s\n&quot;,shmaddr);
        shmdt(shmaddr);
        return 0;
    }else{
        wait();
        printf(&quot;this is parent\n&quot;);  
        shmaddr=(char *)shmat(shmid,NULL,0);
        printf(&quot;%s\n&quot;,shmaddr);
    }
    return 0 ;
}
</code></pre>
</blockquote>

<h4 id="toc_3">4.打印共享内存大小和子进程、父进程进程号</h4>

<p>任务描述：</p>

<ul>
<li>基于task3，在父进程中打印共享内存大小以及父进程的进程号和子进程的进程号</li>
</ul>

<p>main.c：</p>

<blockquote>
<pre><code>#include &quot;stdio.h&quot;
#include &quot;unistd.h&quot;
#include &quot;sys/ipc.h&quot;
#include &quot;sys/shm.h&quot;
#include &quot;error.h&quot;
#include &quot;stdlib.h&quot;
#include &quot;string.h&quot;
int main(void){
    int shmid;char x[10];
    struct shmid_ds buf;
    char *shmaddr;
    shmid=shmget(IPC_PRIVATE,512,IPC_CREAT|0600 ) ;
    if ( shmid &lt; 0 ){
        perror(&quot;get shm ipc_id error\n&quot;) ;
        return -1 ;
    }
    //printf(&quot;shmid is %d\n&quot;,shmid);
    pid_t pid;
    pid=fork();
    if(pid&lt;0){
        perror(&quot;fork error\n&quot;);
        shmctl(shmid,IPC_RMID,&amp;buf); 
    }
    if(pid==0){
        printf(&quot;this is child\n&quot;);
        printf(&quot;child pid is %d\n&quot;,getpid());
        //shmaddr=(char *)shmat(shmid,NULL,0);
        // if(shmaddr&lt;(char *)0)
        // {
        //  perror(&quot;shmat addr error\n&quot;);
            //return -1;
        //}
        //printf(&quot;write something to shm\n&quot;);
        //fgets(x,11,stdin);
        //strcpy(shmaddr,&quot;your input string is&#39;xxx&#39;\n&quot;);
        //shmdt(shmaddr);
        return 0;
    }else{
        //memset(&amp;buf,&#39;\0&#39;,sizeof(buf));
        //wait();
        //printf(&quot;%s\n&quot;,shmaddr);
        shmctl(shmid,IPC_STAT,&amp;buf);
        printf(&quot;The size of new buf is %ld bytes\n&quot;,buf.shm_segsz);
        printf(&quot;this is parent\n&quot;);  
        printf(&quot;parent pid is %d\n&quot;,getpid());
    }
    return 0 ;
}
</code></pre>
</blockquote>

<h4 id="toc_4">5.两个进程通过共享内存通信</h4>

<p>任务描述:</p>

<ul>
<li>编写两个.c文件,分别完成将图书信息写入共享内存以及从共享内存读取图书信息的功能</li>
<li>图书信息(no;name;price)使用结构体定义</li>
<li>01 book1 10</li>
<li>2 book2 20</li>
<li>read.c中读取完毕要删除共享内存</li>
<li>write,c中每次都新建共享内存</li>
<li>ftok</li>
</ul>

<p>写程序:</p>

<ul>
<li>实现父子进程通过共享内存进行数据通信.</li>
<li>父子进程通过竞争方式来创建一个共享内存单元,然后子进程接受用户输入的信息(键盘输入),并将写入到共享内存单元;父进程则从共享内存单元将该信息读出,并显示信息的个数,具体步骤为:创建子进程-&gt;将输入的字符串写入共享内存-&gt;打印写入的字符串-&gt;在父进程中读取写入的字符串并打印</li>
</ul>

<p>write.c:</p>

<blockquote>
<pre><code>#include &quot;stdio.h&quot;
#include &quot;unistd.h&quot;
#include &quot;sys/ipc.h&quot;
#include &quot;sys/shm.h&quot;
#include &quot;error.h&quot;
#include &quot;stdlib.h&quot;
#include &quot;string.h&quot;
#include&quot;sys/types.h&quot;
typedef struct book{
    int num;
    char name[20];
    float price;
}book;
int main(void){
    int shmid,i;
    key_t key;
    book *shmaddr;
    char temp[20];
    key=ftok(&quot;write.c&quot;,0x03);
    if(key==-1){
        perror(&quot;key error\n&quot;);
        return -1;
    }
    printf(&quot;key=%d\n&quot;,key);
    shmid=shmget(key,512,IPC_CREAT|0600 ) ;
    if (shmid&lt;0){
        perror(&quot;shmid get error\n&quot;) ;
        return -1 ;
    }else{ 
        printf(&quot;shmid =%d\n&quot;,shmid);
        shmaddr=(book *)shmat(shmid,NULL,0);
        if(shmaddr&lt;(book *)0){
            perror(&quot;shmat addr error\n&quot;);
            return -1;
        }
        memset(temp,0x00,sizeof(temp));
        strcpy(temp,&quot;book&quot;);
        temp[4]=&#39;0&#39;;
        for(i=0;i&lt;2;i++){
            temp[4]+=1;
            strcpy((shmaddr+i) -&gt; name,temp);
            (shmaddr+i) -&gt; num=i;
            (shmaddr+i)-&gt;price=10*(i+1);
        }
        shmdt(shmaddr);
    }
    return 0 ;
}
</code></pre>
</blockquote>

<p>读程序:</p>

<ul>
<li>采用shmat函数取得对共享内存空间的地址</li>
<li>打印共享内存中的字符串</li>
<li>使用shmdt函数取消父进程与共享内存的关联</li>
<li>使用shmctl函数删除共享内存</li>
</ul>

<p>read.c:</p>

<blockquote>
<pre><code>#include &quot;stdio.h&quot;
#include &quot;unistd.h&quot;
#include &quot;sys/ipc.h&quot;
#include &quot;sys/shm.h&quot;
#include &quot;error.h&quot;
#include &quot;stdlib.h&quot;
#include &quot;string.h&quot;
#include&quot;sys/types.h&quot;
#include&lt;stdio.h&gt;
typedef struct book{
    int num;
    char name[20];
    float price;
}book;
int main(void){
    int shmid,i;
    char temp[20];
    key_t key;
    book *shmaddr;
    key=ftok(&quot;write.c&quot;,0x03);
    if(key==-1){
        perror(&quot;key error\n&quot;);
        return -1;
    }
    printf(&quot;key=%d\n&quot;,key);
    shmid=shmget(key,512,IPC_CREAT|0600 ) ;
    if (shmid&lt;0){
        perror(&quot;shmid get error\n&quot;) ;
        return -1 ;
    }else{ 
        printf(&quot;shmid =%d\n&quot;,shmid);
        shmaddr=(book *)shmat(shmid,NULL,0);
        if(shmaddr&lt;(book *)0){
            perror(&quot;shmat addr error\n&quot;);
            return -1;
        }
        for(i=0;i&lt;2;i++){
            printf(&quot;num:%d,&quot;,(*(shmaddr+i)).num);
            printf(&quot;name:%s,&quot;,(*(shmaddr+i)).name); 
            printf(&quot;price:%f\n&quot;,(*(shmaddr+i)).price);             
        }
        shmdt(shmaddr);
    }
    return 0 ;
}
</code></pre>
</blockquote>

<h4 id="toc_5">6.无名管道</h4>

<p>任务描述:</p>

<ul>
<li>创建管道,父进程接受键盘输入,将其写入管道,子进程读取管道,将读取到的字符串打印出来</li>
</ul>

<p>相关知识:<br/>
　　管道是一种把两个进程之间的标准输入和标准输出连接起来的机制，从而提供一种让多个进程间通信的方法，当进程创建管道时，每次都需要提供两个文件描述符来操作管道。其中一个对管道进行写操作，另一个对管道进行读操作。对管道的读写与一般的IO系统函数一致，使用write()函数写入数据，使用read()读出数据。<br/>
　　<strong>必须在fork()中调用pipe()，否则子进程不会继承文件描述符。</strong>两个进程不共享祖先进程，就不能使用pipe。但是可以使用命名管道。<br/>
main.c:</p>

<blockquote>
<pre><code>#include &quot;unistd.h&quot;
#include &quot;stdio.h&quot;
#define size 100
int main(void){
    int filedes[2];
    char a[size],b[size];
    pid_t pid;
    pipe(filedes);
    pid=fork();        
    if(pid&lt;0){
        printf(&quot;pid error\n&quot;);
        return 0;
    }
    if (pid &gt; 0){
        printf( &quot;This is father process\n&quot;);
        printf(&quot;please input something and wait a little time\n&quot;);
        fgets(a,50,stdin);
        printf(&quot;write pipe:%s\n&quot;,a);
        write( filedes[1],a,sizeof(a));
        close( filedes[0] );
        close( filedes[1] );
    }else if(pid == 0){
        sleep(7);
        printf(&quot;This is child process.\n&quot;);
        read( filedes[0], b, sizeof(b));
        printf( &quot;read pipe: %s\n&quot;, b );
        close( filedes[0] );
        close( filedes[1] );
    }
    waitpid( pid, NULL, 0 );
    return 0;
}
</code></pre>
</blockquote>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15033226512813.html"  title="Previous Post: 僵尸进程和孤儿进程">&laquo; 僵尸进程和孤儿进程</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15033226078265.html" 
	        title="Next Post: 关于mysqld_safe">关于mysqld_safe &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15033226237472.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  </body>
</html>
